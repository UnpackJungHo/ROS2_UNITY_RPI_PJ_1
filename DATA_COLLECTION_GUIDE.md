# 자율주행 데이터 수집 가이드

## 목차
1. [모방학습 원리 이해](#1-모방학습-원리-이해)
2. [데이터 수집 설정](#2-데이터-수집-설정)
3. [효율적인 주행 방법](#3-효율적인-주행-방법)
4. [데이터 품질 체크리스트](#4-데이터-품질-체크리스트)
5. [현재 데이터 문제점 및 해결](#5-현재-데이터-문제점-및-해결)
6. [실전 수집 시나리오](#6-실전-수집-시나리오)

---

## 1. 모방학습 원리 이해

### 1.1 학습 방식
```
┌─────────────────┐     ┌─────────────────┐
│  Front View     │     │                 │
│  이미지 (200x66)│────▶│   신경망 모델   │────▶ steering (-1 ~ +1)
│                 │     │   (ResNet18)    │────▶ throttle (-1 ~ +1)
├─────────────────┤     │                 │
│  Top View       │────▶│                 │
│  이미지 (128x128)     │                 │
└─────────────────┘     └─────────────────┘
```

**핵심 개념:**
- 모델은 "이 이미지가 보일 때, 인간은 어떻게 조작했는가?"를 학습
- 따라서 **좋은 주행 데이터 = 좋은 모델**
- 나쁜 주행 습관도 그대로 학습됨!

### 1.2 데이터 구성
```
TrainingData/session_XXXXXX/
├── front/
│   ├── frame_000000.jpg  ← Front View 이미지
│   ├── frame_000001.jpg
│   └── ...
├── top/
│   ├── frame_000000.jpg  ← Top View 이미지
│   └── ...
├── driving_log.csv       ← steering, throttle, speed, timestamp
└── metadata.json         ← 설정 정보
```

**driving_log.csv 예시:**
```csv
front_image,top_image,steering,throttle,speed,timestamp
front/frame_000000.jpg,top/frame_000000.jpg,0.15,0.80,2.5,0.10
front/frame_000001.jpg,top/frame_000001.jpg,0.20,0.75,2.6,0.20
```

---

## 2. 데이터 수집 설정

### 2.1 Unity Inspector 설정 (DrivingDataCollector)

| 파라미터 | 권장값 | 설명 |
|----------|--------|------|
| `captureInterval` | **0.05** (20 FPS) | 낮을수록 더 많은 데이터 |
| `frontImageWidth` | 200 | 변경 불필요 |
| `frontImageHeight` | 66 | PilotNet 표준 크기 |
| `topViewImageSize` | 128 | 변경 불필요 |
| `topViewHeight` | 8 | 카메라 높이 |

### 2.2 FPS 선택 가이드

| FPS | captureInterval | 장점 | 단점 | 권장 상황 |
|-----|-----------------|------|------|-----------|
| 10 | 0.10 | 저장공간 적음, 빠른 학습 | 데이터 부족 | 테스트용 |
| **20** | **0.05** | **균형 잡힌 선택** | - | **일반 권장** |
| 30 | 0.033 | 데이터 많음 | 중복 데이터, 저장공간 | 짧은 트랙 |

**왜 20 FPS를 권장하나?**
```
- 자율주행 추론 주기: 10Hz (0.1초)
- 20 FPS면 추론 1회당 2개 프레임 데이터
- 충분한 다양성 + 적절한 데이터량
- 30 FPS는 연속 프레임이 거의 동일 → 중복 낭비
```

### 2.3 설정 변경 방법

Unity Inspector에서 `DrivingDataCollector` 컴포넌트 찾기:
```
captureInterval: 0.1  →  0.05 로 변경
```

---

## 3. 효율적인 주행 방법

### 3.1 속도 전략 (핵심!)

```
┌────────────────────────────────────────────────────────┐
│                                                        │
│    ████  직진 구간: 빠르게! (3~4 m/s)                 │
│    ████  → 프레임 수 적어짐 → 직진 데이터 비율 감소   │
│                                                        │
│    ░░░░  커브 구간: 천천히! (1~2 m/s)                 │
│    ░░░░  → 프레임 수 많아짐 → 커브 데이터 비율 증가   │
│                                                        │
└────────────────────────────────────────────────────────┘
```

**왜 이렇게 해야 하나?**
```
예시: 10초 주행, 20 FPS 캡처

[일정 속도로 주행]
- 직진 5초 → 100 프레임 (50%)
- 커브 5초 → 100 프레임 (50%)

[속도 조절 주행]
- 직진 3초 (빠르게) → 60 프레임 (30%)
- 커브 7초 (천천히) → 140 프레임 (70%)

→ 커브 데이터 비율이 50% → 70%로 증가!
```

### 3.2 조향 패턴

**좋은 패턴:**
```
✓ 부드러운 조향 (점진적으로 핸들 돌리기)
✓ 일관된 라인 유지
✓ 커브 진입 전 미리 조향 시작
✓ 커브 중간에서 가장 큰 조향각
```

**나쁜 패턴 (피해야 함):**
```
✗ 급격한 조향 (갑자기 핸들 확 돌리기)
✗ 지그재그 주행
✗ 벽에 부딪힌 후 복구
✗ 멈춰서 방향 전환
```

### 3.3 트랙 주행 전략

```
[1라운드] 시계 방향
    → 우회전 데이터 수집

[2라운드] 반시계 방향
    → 좌회전 데이터 수집

[3라운드] 시계 방향, 다른 속도
    → 속도 다양성 추가

[4라운드] 반시계 방향, 다른 속도
    → 좌회전 + 속도 다양성
```

---

## 4. 데이터 품질 체크리스트

### 4.1 수집 전 체크

- [ ] `captureInterval`이 0.05 (20 FPS) 이하인가?
- [ ] 트랙이 충분히 다양한가? (직진 + 다양한 커브)
- [ ] 조명이 일정한가?

### 4.2 수집 중 체크

- [ ] 벽에 부딪히지 않고 주행하는가?
- [ ] 커브에서 속도를 줄이고 있는가?
- [ ] 부드럽게 조향하고 있는가?
- [ ] 최소 1분 이상 연속 주행하는가?

### 4.3 수집 후 체크

**driving_log.csv 분석:**
```bash
# 세션별 프레임 수 확인
wc -l TrainingData/session_*/driving_log.csv

# steering 분포 확인 (0이 60% 넘으면 문제)
# python으로 분석 권장
```

### 4.4 권장 데이터 분포 (D자 트랙 기준)

**이 트랙의 특징:**
- D자 모양으로 오른쪽에 완만한 커브가 계속됨
- 직선 구간이 짧고, 완만한 커브가 대부분
- 왼쪽 하단에 급커브(90도 꺾임) 있음

**Steering 분류 기준 (세분화):**
| steering 범위 | 분류 | 설명 |
|---------------|------|------|
| < -0.35 | 급좌회전 | 급커브 |
| -0.35 ~ -0.15 | 중간좌회전 | 일반 커브 |
| -0.15 ~ -0.03 | 완만좌회전 | 완만한 커브 |
| **-0.03 ~ 0.03** | **직진** | 핸들 거의 안 돌림 |
| 0.03 ~ 0.15 | 완만우회전 | 완만한 커브 |
| 0.15 ~ 0.35 | 중간우회전 | 일반 커브 |
| > 0.35 | 급우회전 | 급커브 |

**목표 분포:**
| 카테고리 | 목표 비율 |
|----------|-----------|
| 직진 | **≤ 20%** (핵심!) |
| 완만한 커브 (좌+우) | 40-50% |
| 중간 커브 (좌+우) | 20-30% |
| 급커브 (좌+우) | 10-20% |
| 좌회전 총합 | **30-50%** (균형) |
| 우회전 총합 | **30-50%** (균형) |

---

### 4.5 품질 등급 기준 (D자 트랙)

| 등급 | 직진 비율 | 의미 | 조치 |
|------|----------|------|------|
| **EXCELLENT** | ≤ 20% | 커브 데이터 충분 | 그대로 사용 |
| **GOOD** | 21-35% | 양호 | 사용 가능 |
| **FAIR** | 36-50% | 부족 | 커브에서 더 천천히 |
| **POOR** | > 50% | 문제 | 재수집 권장 |

**좌우 균형 체크:**
- 좌회전 또는 우회전이 20% 미만이면 경고 표시
- 해결: 반대 방향으로 추가 주행

---

## 5. 현재 데이터 문제점 및 해결

### 5.1 현재 문제 분석

```
현재 데이터 (5,015 프레임):
├── steering = 0: 60.2% ← 너무 많음!
├── 좌회전: 6.4% ← 너무 적음!
├── 우회전: 26.9%
└── 총 데이터: 5,015개 ← 부족!
```

### 5.2 해결 전략

**단기 해결 (코드로):**
- ✅ 가중치 샘플링 적용 (train_imitation_v2.py에 구현됨)
- ✅ 좌우 반전 증강으로 좌회전 데이터 보강

**장기 해결 (데이터 수집):**
```
목표: 최소 20,000 프레임

새로 수집할 데이터:
├── 반시계 방향 주행 (좌회전 강화): 5,000+ 프레임
├── 다양한 속도: 5,000+ 프레임
├── 커브 위주 트랙: 5,000+ 프레임
└── 총 추가: 15,000+ 프레임
```

---

## 6. 실전 수집 시나리오

### 6.1 기본 수집 (최소 요구사항)

```
세션 1: 시계 방향, 보통 속도 (2분)
        → 약 2,400 프레임 (20 FPS 기준)

세션 2: 반시계 방향, 보통 속도 (2분)
        → 약 2,400 프레임

세션 3: 시계 방향, 커브 천천히 (3분)
        → 약 3,600 프레임

세션 4: 반시계 방향, 커브 천천히 (3분)
        → 약 3,600 프레임

총: 약 12,000 프레임 (최소 권장)
```

### 6.2 고품질 수집 (권장)

```
[Phase 1: 기본 주행] 4 세션 × 2분 = 약 9,600 프레임
- 시계/반시계 각 2회
- 일정 속도

[Phase 2: 속도 변화] 4 세션 × 2분 = 약 9,600 프레임
- 직진 빠르게, 커브 천천히
- 시계/반시계 각 2회

[Phase 3: 커브 집중] 2 세션 × 3분 = 약 7,200 프레임
- 커브가 많은 구간 반복
- 아주 천천히 주행

총: 약 26,400 프레임 (권장)
```

### 6.3 수집 명령어 정리

**Unity에서:**
```
R키: 녹화 시작/중지
T키: 데이터 저장

주행 순서:
1. R키 눌러 녹화 시작
2. 트랙 주행 (1~3분)
3. R키 눌러 녹화 중지
4. T키 눌러 저장
5. 다음 세션 반복
```

---

## 7. 요약: 데이터 수집 황금률

```
┌────────────────────────────────────────────────────────┐
│                                                        │
│  1. FPS: 20 (captureInterval = 0.05)                  │
│                                                        │
│  2. 직진은 빠르게, 커브는 천천히                       │
│                                                        │
│  3. 시계 + 반시계 방향 모두 주행                       │
│                                                        │
│  4. 최소 10,000 프레임, 권장 30,000+ 프레임           │
│                                                        │
│  5. 부드러운 조향, 벽 충돌 금지                        │
│                                                        │
│  6. 다양한 속도로 여러 번 주행                         │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

## 부록: 빠른 데이터 분석 스크립트

데이터 수집 후 품질 확인용:

```bash
conda activate driving
cd /home/kjhz/ros2_unity_rpi/ros2_unity_autoDriver

python3 -c "
import pandas as pd
import glob

sessions = sorted(glob.glob('TrainingData/session_*'))
all_data = []

for s in sessions:
    df = pd.read_csv(f'{s}/driving_log.csv')
    all_data.append(df)
    print(f'{s.split(\"/\")[-1]}: {len(df)} frames')

combined = pd.concat(all_data)
print(f'\n총 프레임: {len(combined)}')
print(f'직진 비율 (|steering| < 0.05): {(abs(combined[\"steering\"]) < 0.05).mean()*100:.1f}%')
print(f'좌회전 비율 (steering < -0.05): {(combined[\"steering\"] < -0.05).mean()*100:.1f}%')
print(f'우회전 비율 (steering > 0.05): {(combined[\"steering\"] > 0.05).mean()*100:.1f}%')
"
```

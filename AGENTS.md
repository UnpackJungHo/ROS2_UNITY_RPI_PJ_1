# AGENTS.md - ROS2 Unity AutoDriver

## Project Overview

Unity 2022.3 robotics simulation project for ROS2-based autonomous mobile robot (AMR) development.
Integrates with ROS2 via Unity Robotics packages for URDF import and TCP communication.

**Tech Stack**: Unity 2022.3.62f3, C# 9.0, .NET Standard 2.1, ros2 jazzy

---

## Build Commands

### Unity Editor (Primary)

```bash
# Open project in Unity Editor
/home/kjhz/Unity/Hub/Editor/2022.3.62f3/Editor/Unity -projectPath .

# Build from command line (headless)
/home/kjhz/Unity/Hub/Editor/2022.3.62f3/Editor/Unity \
  -projectPath . \
  -batchmode \
  -nographics \
  -buildTarget StandaloneLinux64 \
  -executeMethod BuildScript.Build \
  -quit

# Run tests (Unity Test Framework)
/home/kjhz/Unity/Hub/Editor/2022.3.62f3/Editor/Unity \
  -projectPath . \
  -batchmode \
  -nographics \
  -runTests \
  -testPlatform EditMode \
  -testResults ./TestResults.xml
```

### IDE Build (for syntax checking)

```bash
# Build solution (requires dotnet SDK)
dotnet build ros2_unity_autoDriver.sln

# Restore packages
dotnet restore ros2_unity_autoDriver.sln
```

**Note**: The .csproj files are auto-generated by Unity. Do not edit them manually.

---

## Test Commands

### Unity Test Framework

```bash
# Run all EditMode tests
Unity -batchmode -projectPath . -runTests -testPlatform EditMode -quit

# Run all PlayMode tests
Unity -batchmode -projectPath . -runTests -testPlatform PlayMode -quit

# Run specific test class
Unity -batchmode -projectPath . -runTests -testFilter "TestClassName" -quit

# Run single test method
Unity -batchmode -projectPath . -runTests -testFilter "TestClassName.TestMethodName" -quit

# Output test results to file
Unity -batchmode -projectPath . -runTests -testResults ./results.xml -quit
```

### In-Editor Testing

- Window > General > Test Runner
- Select EditMode or PlayMode tab
- Right-click test to run individual tests

---

## Lint / Static Analysis

### Unity Roslyn Analyzers (Built-in)

The project uses Microsoft.Unity.Analyzers (auto-configured via VS Code extension).
Warnings appear in Unity Console and IDE.

### Manual Inspection

```bash
# Check for compiler warnings (requires dotnet)
dotnet build ros2_unity_autoDriver.sln /warnaserror

# List all TODO/FIXME comments
grep -rn "TODO\|FIXME\|HACK" Assets/Scripts/
```

### Recommended: Add .editorconfig

Create `.editorconfig` in project root for consistent formatting:

```ini
root = true

[*.cs]
indent_style = space
indent_size = 4
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true
```

---

## Code Style Guidelines

### File Organization

```
Assets/
  Scripts/           # All C# scripts
  Scenes/            # Unity scene files
  Robots/            # URDF models and robot assets
    {RobotName}/
      {robot}.urdf
      Materials/
      meshes/
```

### Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Classes | PascalCase | `WheelTest`, `RobotController` |
| Public Fields | camelCase | `maxSteeringAngle`, `targetVelocity` |
| Private Fields | camelCase | `currentSteeringAngle` |
| Methods | PascalCase | `UpdateSteering()`, `SetWheelVelocity()` |
| Constants | PascalCase | `MaxSpeed` |
| Parameters | camelCase | `input`, `angle`, `velocity` |

### Import Organization

```csharp
// 1. Unity namespaces
using UnityEngine;
using UnityEngine.UI;

// 2. Third-party packages
using RosMessageTypes.Geometry;
using Unity.Robotics.ROSTCPConnector;

// 3. Project namespaces (if any)
```

### Class Structure

```csharp
public class ExampleBehaviour : MonoBehaviour
{
    // [Header] attributes for Inspector organization
    [Header("Category Name")]
    public Type publicField;
    
    // Private fields
    private Type _privateField;
    
    // Unity lifecycle methods (in order)
    void Awake() { }
    void Start() { }
    void Update() { }
    void FixedUpdate() { }
    void OnDestroy() { }
    
    // Public methods
    public void PublicMethod() { }
    
    // Private methods
    void PrivateMethod() { }
}
```

### Error Handling

```csharp
// Null checks with early return
if (component == null) return;

// Use null-conditional for optional operations
gameObject?.SetActive(true);

// Debug.Log for development, remove for production
Debug.Log($"Value: {value}");
Debug.LogWarning("Warning message");
Debug.LogError("Error message");
```

### Unity-Specific Patterns

```csharp
// Prefer SerializeField over public for Inspector access
[SerializeField] private float speed;

// Use Header for grouping in Inspector
[Header("Movement Settings")]
public float moveSpeed;
public float turnSpeed;

// Cache component references
private Rigidbody _rb;
void Awake() => _rb = GetComponent<Rigidbody>();

// Use ArticulationBody for physics-based robotics
ArticulationDrive drive = articulationBody.xDrive;
drive.target = targetAngle;
articulationBody.xDrive = drive;
```

---

## Key Dependencies

### Unity Packages (Packages/manifest.json)

| Package | Purpose |
|---------|---------|
| `com.unity.robotics.ros-tcp-connector` | ROS2 communication |
| `com.unity.robotics.urdf-importer` | URDF robot model import |

### External Requirements

- Unity Hub with Unity 2022.3.62f3
- ROS2 (Humble/Iron) for runtime communication
- `ros_tcp_endpoint` ROS2 package on robot side

---

## Agent-Specific Notes

### When Editing C# Scripts

1. Scripts live in `Assets/Scripts/`
2. Class name MUST match filename exactly
3. After editing, Unity recompiles automatically (hot reload)
4. Check Unity Console for compile errors

### When Adding New Scripts

```csharp
// Template for new MonoBehaviour
using UnityEngine;

public class NewScript : MonoBehaviour
{
    void Start()
    {
        
    }
    
    void Update()
    {
        
    }
}
```

### When Working with URDF

- URDF files in `Assets/Robots/{RobotName}/`
- Use Unity > Assets > Import Robot from URDF
- Meshes in relative `meshes/` folder
- Materials auto-generated in `Materials/`

### ROS2 Integration Pattern

```csharp
using Unity.Robotics.ROSTCPConnector;
using RosMessageTypes.Geometry;

public class ROSPublisher : MonoBehaviour
{
    ROSConnection ros;
    string topicName = "/cmd_vel";
    
    void Start()
    {
        ros = ROSConnection.GetOrCreateInstance();
        ros.RegisterPublisher<TwistMsg>(topicName);
    }
    
    void Publish(float linear, float angular)
    {
        var msg = new TwistMsg
        {
            linear = new Vector3Msg { x = linear },
            angular = new Vector3Msg { z = angular }
        };
        ros.Publish(topicName, msg);
    }
}
```

---

## Common Issues

| Issue | Solution |
|-------|----------|
| Scripts not compiling | Check Unity Console for errors |
| Missing references in Inspector | Re-assign in Unity Editor |
| URDF import fails | Check mesh paths are relative |
| ROS connection fails | Verify `ros_tcp_endpoint` is running |

---

## Quick Reference

```bash
# Unity Editor location
/home/kjhz/Unity/Hub/Editor/2022.3.62f3/Editor/Unity

# Project structure
.
├── Assets/
│   ├── Scripts/      # C# code
│   ├── Scenes/       # Unity scenes
│   └── Robots/       # URDF models
├── Packages/         # Unity package dependencies
└── ProjectSettings/  # Unity project config
```
